;
; Xabarnoma Notification System - Custom Dialplan Contexts
; This file should be included in Asterisk's extensions_custom.conf
;

[xabarnoma-broadcast]
; Context for broadcast calls with audio playback
exten => _X.,1,NoOp(Xabarnoma broadcast to ${EXTEN})
 same => n,Set(BROADCAST_ID=${BROADCAST_ID})
 same => n,Set(AUDIO_FILE=${AUDIO_FILE})
 same => n,Set(REPEAT_COUNT=3)
 same => n,Set(REPEAT_INTERVAL=2)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(i=1)
 same => n(repeat),NoOp(Playing audio, attempt ${i})
 same => n,Playback(${AUDIO_FILE})
 same => n,Wait(${REPEAT_INTERVAL})
 same => n,Set(i=$[${i} + 1])
 same => n,GotoIf($[${i} <= ${REPEAT_COUNT}]?repeat)
 same => n,Hangup()

[xabarnoma-broadcast-dtmf]
; Context for broadcast calls with DTMF confirmation
exten => _X.,1,NoOp(Xabarnoma broadcast with confirmation to ${EXTEN})
 same => n,Set(BROADCAST_ID=${BROADCAST_ID})
 same => n,Set(AUDIO_FILE=${AUDIO_FILE})
 same => n,Set(CONFIRMED=0)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Set(i=1)
 same => n(repeat),NoOp(Playing audio with DTMF check, attempt ${i})
 same => n,Background(${AUDIO_FILE})
 same => n,WaitExten(5)
 same => n,GotoIf($[${CONFIRMED} = 1]?confirmed)
 same => n,Set(i=$[${i} + 1])
 same => n,GotoIf($[${i} <= 3]?repeat)
 same => n,Goto(notconfirmed)
 same => n(confirmed),NoOp(Broadcast confirmed by ${CALLERID(num)})
 same => n,AGI(xabarnoma-confirm.agi,${BROADCAST_ID},${CALLERID(num)},1)
 same => n,Playback(beep)
 same => n,Hangup()
 same => n(notconfirmed),NoOp(Broadcast not confirmed)
 same => n,Hangup()

; DTMF handler
exten => 1,1,Set(CONFIRMED=1)
 same => n,Goto(${CONTEXT},${BROADCAST_EXTEN},confirmed)

[xabarnoma-early-media]
; Context for early media audio playback (183 Session Progress)
exten => _X.,1,NoOp(Xabarnoma early media to ${EXTEN})
 same => n,Set(BROADCAST_ID=${BROADCAST_ID})
 same => n,Set(AUDIO_FILE=${AUDIO_FILE})
 same => n,Progress()
 same => n,Wait(1)
 same => n,Playback(${AUDIO_FILE},noanswer)
 same => n,Wait(2)
 same => n,Answer()
 same => n,Playback(${AUDIO_FILE})
 same => n,Hangup()

[xabarnoma-test]
; Test context for debugging
exten => 999,1,NoOp(Xabarnoma test call)
 same => n,Answer()
 same => n,Playback(hello-world)
 same => n,Wait(2)
 same => n,Playback(tt-monkeys)
 same => n,Hangup()