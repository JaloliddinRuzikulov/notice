<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Audio Test - Qashqadaryo IIB</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .test-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .button-group {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        #phoneNumber {
            padding: 10px;
            font-size: 18px;
            width: 100%;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        #logOutput {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>WebRTC Audio Test</h1>
        
        <div id="status" class="status-box status-info">
            Initializing...
        </div>
        
        <div id="sipStatus" class="status-box status-info">
            SIP Status: Not connected
        </div>
        
        <input type="tel" id="phoneNumber" placeholder="Enter phone number (e.g., 1001)" />
        
        <div class="button-group">
            <button id="initBtn" class="btn-primary" onclick="initializeSIP()">Initialize SIP</button>
            <button id="callBtn" class="btn-success" onclick="makeCall()" disabled>Make Call</button>
            <button id="hangupBtn" class="btn-danger" onclick="hangupCall()" disabled>Hang Up</button>
            <button id="testAudioBtn" class="btn-primary" onclick="testAudio()">Test Audio</button>
        </div>
        
        <div id="logOutput"></div>
    </div>

    <script src="/js/sip-0.13.5.min.js"></script>
    <script>
        let userAgent = null;
        let session = null;
        let remoteAudio = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status-box status-' + type;
        }

        function updateSIPStatus(message, type = 'info') {
            const statusDiv = document.getElementById('sipStatus');
            statusDiv.textContent = 'SIP Status: ' + message;
            statusDiv.className = 'status-box status-' + type;
        }

        async function initializeSIP() {
            try {
                updateStatus('Initializing WebRTC SIP...', 'info');
                log('Starting SIP initialization');

                // Create user agent configuration
                const config = {
                    uri: 'sip:5530@10.105.0.3',
                    transportOptions: {
                        wsServers: ['wss://172.27.64.10:8444/ws'],
                        traceSip: true
                    },
                    authorizationUser: '5530',
                    password: '5530',
                    displayName: 'WebRTC Test',
                    register: true,
                    sessionDescriptionHandlerFactoryOptions: {
                        constraints: {
                            audio: true,
                            video: false
                        },
                        peerConnectionOptions: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:10.105.0.3:3478' }
                            ]
                        }
                    }
                };

                log('Creating user agent with config: ' + JSON.stringify(config, null, 2));
                userAgent = new SIP.UA(config);

                // Set up event listeners
                userAgent.on('connected', function() {
                    log('WebSocket connected', 'success');
                    updateStatus('WebSocket connected', 'success');
                });

                userAgent.on('disconnected', function() {
                    log('WebSocket disconnected', 'error');
                    updateStatus('WebSocket disconnected', 'error');
                });

                userAgent.on('registered', function() {
                    log('SIP registered successfully', 'success');
                    updateSIPStatus('Registered', 'success');
                    document.getElementById('callBtn').disabled = false;
                });

                userAgent.on('unregistered', function() {
                    log('SIP unregistered');
                    updateSIPStatus('Unregistered', 'error');
                    document.getElementById('callBtn').disabled = true;
                });

                userAgent.on('registrationFailed', function(response, cause) {
                    log('Registration failed: ' + cause, 'error');
                    updateSIPStatus('Registration failed', 'error');
                });

                userAgent.on('invite', function(incomingSession) {
                    log('Incoming call from: ' + incomingSession.remoteIdentity.displayName);
                    handleIncomingCall(incomingSession);
                });

                // Start the user agent
                log('Starting user agent...');
                userAgent.start();

            } catch (error) {
                log('Error initializing SIP: ' + error.message, 'error');
                updateStatus('Initialization failed: ' + error.message, 'error');
            }
        }

        async function makeCall() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }

            try {
                log('Making call to: ' + phoneNumber);
                updateStatus('Calling ' + phoneNumber + '...', 'info');

                // Create audio element for remote audio
                if (!remoteAudio) {
                    remoteAudio = document.createElement('audio');
                    remoteAudio.autoplay = true;
                    document.body.appendChild(remoteAudio);
                }

                // Make the call
                session = userAgent.invite('sip:' + phoneNumber + '@10.105.0.3', {
                    sessionDescriptionHandlerOptions: {
                        constraints: {
                            audio: true,
                            video: false
                        }
                    }
                });

                // Set up session event handlers
                session.on('accepted', function() {
                    log('Call connected', 'success');
                    updateStatus('Call connected', 'success');
                    document.getElementById('callBtn').disabled = true;
                    document.getElementById('hangupBtn').disabled = false;

                    // Attach remote stream
                    const pc = session.sessionDescriptionHandler.peerConnection;
                    pc.ontrack = function(event) {
                        log('Received remote audio track');
                        remoteAudio.srcObject = event.streams[0];
                    };
                });

                session.on('failed', function(response, cause) {
                    log('Call failed: ' + cause, 'error');
                    updateStatus('Call failed: ' + cause, 'error');
                    document.getElementById('callBtn').disabled = false;
                    document.getElementById('hangupBtn').disabled = true;
                });

                session.on('terminated', function() {
                    log('Call ended');
                    updateStatus('Call ended', 'info');
                    document.getElementById('callBtn').disabled = false;
                    document.getElementById('hangupBtn').disabled = true;
                });

            } catch (error) {
                log('Error making call: ' + error.message, 'error');
                updateStatus('Call failed: ' + error.message, 'error');
            }
        }

        function hangupCall() {
            if (session) {
                log('Hanging up call');
                session.terminate();
            }
        }

        function handleIncomingCall(incomingSession) {
            log('Handling incoming call');
            
            if (confirm('Incoming call. Answer?')) {
                session = incomingSession;
                session.accept();
                
                session.on('accepted', function() {
                    log('Incoming call accepted', 'success');
                    updateStatus('Call connected', 'success');
                    document.getElementById('callBtn').disabled = true;
                    document.getElementById('hangupBtn').disabled = false;
                });
            } else {
                incomingSession.reject();
                log('Incoming call rejected');
            }
        }

        async function testAudio() {
            try {
                log('Testing audio permissions...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('Audio permissions granted', 'success');
                updateStatus('Audio test successful', 'success');
                
                // Stop the test stream
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                log('Audio test failed: ' + error.message, 'error');
                updateStatus('Audio test failed: ' + error.message, 'error');
            }
        }

        // Initialize on page load
        window.onload = function() {
            log('Page loaded, ready to initialize');
            updateStatus('Ready to initialize', 'info');
        };
    </script>
</body>
</html>