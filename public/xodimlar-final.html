<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Xodimlar</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
        }
        .header {
            background: #2196F3;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background: #45a049; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #d32f2f; }
        .btn-warning { background: #ff9800; }
        .btn-warning:hover { background: #f57c00; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .status.show { display: block; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Xodimlar Tizimi</h1>
        <div>
            <a href="/logout" class="btn btn-danger">Chiqish</a>
        </div>
    </div>

    <div class="container">
        <div id="status" class="status"></div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Xodimlar Ro'yxati</h2>
            <div>
                <button class="btn" onclick="yangiXodim()">➕ Yangi Xodim</button>
                <button class="btn btn-warning" onclick="yuklash()">🔄 Yangilash</button>
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>№</th>
                    <th>F.I.O</th>
                    <th>Lavozimi</th>
                    <th>Telefon</th>
                    <th>Amallar</th>
                </tr>
            </thead>
            <tbody id="xodimlarJadvali">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 40px;">
                        <div>📋 Yuklanmoqda...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Yangi Xodim</h2>
            <form id="xodimForm">
                <input type="hidden" id="xodimId">
                
                <div class="form-group">
                    <label for="ism">F.I.O *</label>
                    <input type="text" id="ism" required>
                </div>
                
                <div class="form-group">
                    <label for="lavozim">Lavozimi</label>
                    <input type="text" id="lavozim">
                </div>
                
                <div class="form-group">
                    <label for="telefon">Telefon *</label>
                    <input type="text" id="telefon" required>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" class="btn btn-danger" onclick="modalYopish()">Bekor qilish</button>
                    <button type="button" class="btn" onclick="saqlash()">Saqlash</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="debug" id="debug">
        <strong>Debug Info:</strong><br>
        <div id="debugInfo">Sahifa yuklandi...</div>
    </div>

<script>
let xodimlar = [];
let debugMessages = [];

function debug(message) {
    const now = new Date().toLocaleTimeString();
    debugMessages.push(`${now}: ${message}`);
    if (debugMessages.length > 20) debugMessages.shift();
    
    document.getElementById('debugInfo').innerHTML = debugMessages.join('<br>');
    console.log('DEBUG:', message);
}

function showStatus(message, type = 'info') {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status show ${type}`;
    
    setTimeout(() => {
        statusDiv.className = 'status';
    }, 5000);
    
    debug(`Status: ${message} (${type})`);
}

function yangiXodim() {
    debug('yangiXodim() funksiyasi chaqirildi');
    
    document.getElementById('modalTitle').textContent = 'Yangi Xodim Qo\'shish';
    document.getElementById('xodimId').value = '';
    document.getElementById('ism').value = '';
    document.getElementById('lavozim').value = '';
    document.getElementById('telefon').value = '';
    
    document.getElementById('modal').style.display = 'block';
    
    debug('Modal ochildi');
    showStatus('Yangi xodim qo\'shish oynasi ochildi', 'info');
}

function tahrirlash(id) {
    debug(`tahrirlash(${id}) funksiyasi chaqirildi`);
    
    const xodim = xodimlar.find(x => x.id === id);
    if (!xodim) {
        debug('Xodim topilmadi!');
        showStatus('Xodim topilmadi!', 'error');
        return;
    }
    
    document.getElementById('modalTitle').textContent = 'Xodimni Tahrirlash';
    document.getElementById('xodimId').value = xodim.id;
    document.getElementById('ism').value = xodim.name;
    document.getElementById('lavozim').value = xodim.position || '';
    document.getElementById('telefon').value = xodim.phoneNumber;
    
    document.getElementById('modal').style.display = 'block';
    
    debug('Tahrirlash modali ochildi');
    showStatus('Tahrirlash oynasi ochildi', 'info');
}

function modalYopish() {
    debug('modalYopish() funksiyasi chaqirildi');
    document.getElementById('modal').style.display = 'none';
    debug('Modal yopildi');
    showStatus('Oyna yopildi', 'info');
}

async function saqlash() {
    debug('saqlash() funksiyasi chaqirildi');
    
    const id = document.getElementById('xodimId').value;
    const ism = document.getElementById('ism').value.trim();
    const lavozim = document.getElementById('lavozim').value.trim();
    const telefon = document.getElementById('telefon').value.trim();
    
    if (!ism || !telefon) {
        debug('Majburiy maydonlar to\'ldirilmagan');
        showStatus('Ism va telefon majburiy!', 'error');
        return;
    }
    
    const data = {
        name: ism,
        position: lavozim,
        phoneNumber: telefon,
        department: '',
        district: ''
    };
    
    debug(`Ma'lumot tayyorlandi: ${JSON.stringify(data)}`);
    
    try {
        const url = id ? `/api/employees/${id}` : '/api/employees';
        const method = id ? 'PUT' : 'POST';
        
        debug(`${method} so'rov: ${url}`);
        showStatus('Saqlanmoqda...', 'info');
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        
        debug(`Response status: ${response.status}`);
        
        if (response.ok) {
            const result = await response.json();
            debug(`Saqlash muvaffaqiyatli: ${JSON.stringify(result)}`);
            showStatus(id ? 'Xodim yangilandi!' : 'Xodim qo\'shildi!', 'success');
            modalYopish();
            yuklash();
        } else {
            const errorText = await response.text();
            debug(`Saqlash xatosi: ${errorText}`);
            showStatus('Saqlashda xatolik yuz berdi', 'error');
        }
    } catch (error) {
        debug(`Saqlash exception: ${error.message}`);
        showStatus('Saqlashda xatolik: ' + error.message, 'error');
    }
}

async function ochirish(id) {
    debug(`ochirish(${id}) funksiyasi chaqirildi`);
    
    const xodim = xodimlar.find(x => x.id === id);
    if (!xodim) {
        debug('Xodim topilmadi!');
        showStatus('Xodim topilmadi!', 'error');
        return;
    }
    
    const tasdiqlash = confirm(`"${xodim.name}" ni o'chirishni xohlaysizmi?`);
    if (!tasdiqlash) {
        debug('O\'chirish bekor qilindi');
        return;
    }
    
    try {
        debug(`DELETE so'rov: /api/employees/${id}`);
        showStatus('O\'chirilmoqda...', 'info');
        
        const response = await fetch(`/api/employees/${id}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        
        debug(`DELETE response status: ${response.status}`);
        
        if (response.ok) {
            debug('O\'chirish muvaffaqiyatli');
            showStatus('Xodim o\'chirildi!', 'success');
            yuklash();
        } else {
            const errorText = await response.text();
            debug(`O\'chirish xatosi: ${errorText}`);
            showStatus('O\'chirishda xatolik yuz berdi', 'error');
        }
    } catch (error) {
        debug(`O\'chirish exception: ${error.message}`);
        showStatus('O\'chirishda xatolik: ' + error.message, 'error');
    }
}

async function yuklash() {
    debug('yuklash() funksiyasi chaqirildi');
    showStatus('Ma\'lumotlar yuklanmoqda...', 'info');
    
    try {
        const response = await fetch('/api/employees', {
            credentials: 'same-origin'
        });
        
        debug(`GET response status: ${response.status}`);
        
        if (response.status === 401) {
            debug('Avtorizatsiya xatosi - login sahifasiga yo\'naltirilmoqda');
            window.location.href = '/login';
            return;
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        debug(`Ma'lumot olindi: ${JSON.stringify(data).substring(0, 100)}...`);
        
        // API turli formatda qaytarishi mumkin
        if (Array.isArray(data)) {
            xodimlar = data;
        } else if (data.employees) {
            xodimlar = data.employees;
        } else if (data.success && data.employees) {
            xodimlar = data.employees;
        } else {
            xodimlar = [];
        }
        
        debug(`${xodimlar.length} ta xodim yuklandi`);
        jadvalniBosaditirish();
        showStatus(`${xodimlar.length} ta xodim yuklandi`, 'success');
        
    } catch (error) {
        debug(`Yuklash exception: ${error.message}`);
        showStatus('Yuklashda xatolik: ' + error.message, 'error');
        
        document.getElementById('xodimlarJadvali').innerHTML = 
            '<tr><td colspan="5" style="text-align: center; color: red; padding: 40px;">❌ Xatolik yuz berdi!</td></tr>';
    }
}

function jadvalniBosaditirish() {
    debug('jadvalniBosaditirish() funksiyasi chaqirildi');
    
    const tbody = document.getElementById('xodimlarJadvali');
    
    if (xodimlar.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">📋 Xodimlar ro\'yxati bo\'sh</td></tr>';
        return;
    }
    
    const qatorlar = xodimlar.map((xodim, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${xodim.name}</td>
            <td>${xodim.position || '-'}</td>
            <td>${xodim.phoneNumber}</td>
            <td>
                <button class="btn btn-warning" onclick="tahrirlash('${xodim.id}')">✏️ Tahrirlash</button>
                <button class="btn btn-danger" onclick="ochirish('${xodim.id}')">🗑️ O'chirish</button>
            </td>
        </tr>
    `).join('');
    
    tbody.innerHTML = qatorlar;
    debug(`${xodimlar.length} ta qator jadvalga qo'shildi`);
}

// Modal tashqarisiga bosilganda yopish
document.getElementById('modal').addEventListener('click', function(event) {
    if (event.target === this) {
        debug('Modal tashqarisiga bosildi');
        modalYopish();
    }
});

// Sahifa yuklanganda
debug('Sahifa to\'liq yuklandi');
yuklash();
</script>

</body>
</html>